## TCP 三次握手

1. 客户端发送一个 `SYN` 报文，客户端进入 `SYN_SENT` 状态；
2. 服务端接收到客户端的 `SYN` 报文，服务端发送一个 `SYN_ACK` 报文，服务端进入 `SYN_RCVD` 状态；
3. 客户端接收到服务端发送的报文，返回服务端 `ACK` 报文作为回应
4. 建立连接，进入 `ESTABLISH` 状态



#### 延伸：为什么不可以两次或者四次？

三次握手确保的是 客户端 和 服务端 的接收和发送能力都可以。

如果两次握手的话，可能无法确定客户端的接收能力是否正常。四次的话，可以优化成三次。





## TCP 四次挥手

1. 第一次挥手：客户端发送一个 `FIN` 报文给服务端，表示要断开数据传送，报文中会指定一个序列号 `(seq=x)`。然后客户端进入 `FIN-WAIT-1` 状态。

2. 第二次挥手：服务端收到 `FIN` 报文后，回复 `ACK` 报文给客户端，且把客户端的序列号 +1，作为 `ACK` 报文的序列号 `(seq=x+1)`。然后，服务端进入 `CLOSE-WAIT（seq=x+1）` 状态，客户端进入 `FIN-WAIT-2` 状态

3. 第三次挥手：服务端也要断开连接时，发送 `FIN` 报文给客户端，且指定一个序列号 `(seq=y+1)`，随后服务端进入 `LAST-ACK` 状态

4. 第四次挥手：客户端收到 `FIN` 报文后，发出 `ACK` 报文进行回答，并把服务端的序列号值 +1 作为 ACK 报文序列号 `(seq=y+2)`。此时客户端进入 `TIME-WAIT` 状态。服务端收到客户端的 `ACK` 报文后进入 `CLOSE` 状态。如果客户端等待 `2MSL` 没有收到回复，才关闭连接。

   

<img src="./images/Screenshot 2025-02-27 at 3.27.51 PM.png" alt="Screenshot 2025-02-27 at 3.27.51 PM" style="zoom:50%;" />



#### 延伸：为什么一定是四次？

因为 TCP 是可靠通信，所以需要确保双方都在确认结束后才关闭连接。只有通过四次挥手，才可以确保双方都能接收到对方的最后一个数据段的确认，主动关闭方在发送完送最后一个 `ACK` 后进入 `TIME-WAIT` 状态，这是为了确保被动关闭方收到最终的 `ACK`，如果被动关闭方没有接收到，会重发 `FIN` 报文，关闭方可以再次发送 `ACK`。















