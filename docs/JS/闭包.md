# 闭包 Closure

什么是闭包？

闭包就是引用到了外部变量，这就会形成闭包。

- JS 中的作用域和作用域链
  - 作用域是一个独立的地盘，变量不会外泄和暴露，不同作用域下同名变量不会冲突
  - 作用域在定义时就确定，并且不会改变
  - 当前作用域没有查到值，会向上级作用域查，直到查到全局作用域，这么一个查找过程形成的链条会叫做作用域链
- JS 中的垃圾回收 
  - 垃圾收集器周期性的找出不使用的变量



> 定义函数时，周围环境中的信息可以在函数中使用。
>
> 执行函数时，只要在函数中使用了外部的数据，就形成了闭包。



 

```js
var i = 1;
function a() {
  // 创建了闭包 用到了 i
  console.log(i);
}
a();
```





## 闭包问题

自动形成的闭包，是会被销毁的

```js
function eat() {
  var food = "鸡翅";
  console.log(food);
}
eat();
console.log(food) // 报错 

// ====== 改成 =======

function eat() {
  var food = "鸡翅";
  return function() {
    console.log(food);
  }
}
var look = eat();
look(); // 鸡翅
```

我们可以看到 下面的这段代码可以保存代码块内的变量 让他可以在外部进行访问。

1. 通过闭包可以让外部环境访问到函数内部的局部变量；
2. 通过闭包可以让局部变量持续保存下来，不让他随 着上下文一起被销毁。





## 面试考题

```js
for (var i = 0; i < 3; i++) {
  setTimeout(function () {
    console.log(i);
  });
}
```

最终的结果是 333。为什么？

因为这个函数运用到了外部的变量，这就形成了闭包。闭包是去访问外部的变量，但是外部的变量此时已经变成了 3，所以这里log是3.

如何使输出变成 0 1 2 呢？

```js
// 1. 使用let ES6的新语法
for (let i = 0; i < 3; i++) {
  setTimeout(function () {
    console.log(i);
  });
}

// 2. 放到一个立即执行函数，接收一个i，这样子每一次都会传进来
for (let i = 0; i < 3; i++) {
  (function(index) {
    setTimeout(function () {
      console.log(i);
    });
  })(i)
}
```

 



























